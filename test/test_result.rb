require "minitest/autorun"
require "jirarest2/connect"
require "jirarest2/credentials"
require "jirarest2/result"
require "webmock/minitest"

class TestResult < MiniTest::Unit::TestCase
  def setup
    cred = PasswordCredentials.new("http://localhost:2990/jira/rest/api/2/","test","1234")
    @con = Connect.new(cred)
    stub_request(:get, "http://test:1234@localhost:2990/jira/rest/auth/latest/session").with(:headers => {'Accept'=>'*/*', 'Content-Type'=>'application/json;charset=UTF-8', 'User-Agent'=>'Ruby'}).to_return(:status => 200, :body => "", :headers => {})
  end

  def test_code
    stub_request(:get, "http://test:1234@localhost:2990/jira/rest/api/2/issue/createmeta/").with(:headers => {'Accept'=>'*/*', 'Content-Type'=>'application/json;charset=UTF-8', 'User-Agent'=>'Ruby'}).to_return(:status => 200, :body => "", :headers => {})
    assert_equal "200", @con.execute("Get","issue/createmeta/","").code
  end

  def test_code_400
    stub_request(:get, "http://test:1234@localhost:2990/jira/rest/api/2/issue/createmeta/").with(:headers => {'Content-Type'=>'application/json;charset=UTF-8'}).to_return(:status => 400, :body => "", :headers => {})
    assert_raises(Jirarest2::BadRequestError) { 
      @con.execute("Get","issue/createmeta/","").code
    }
  end


  def test_header
    stub_request(:get, "http://test:1234@localhost:2990/jira/rest/api/2/issue/createmeta/").with(:headers => {'Accept'=>'*/*', 'Content-Type'=>'application/json;charset=UTF-8', 'User-Agent'=>'Ruby'}).to_return(:status => 200, :body => "", :headers => {"X-AUSERNAME" => "test"})
    assert_equal ["test"], @con.execute("Get","issue/createmeta/","").header["x-ausername"]
  end
  
  
  def test_result
    stub_request(:get, "http://test:1234@localhost:2990/jira/rest/api/2/issue/createmeta/").with(:headers => {'Accept'=>'*/*', 'Content-Type'=>'application/json;charset=UTF-8', 'User-Agent'=>'Ruby'}).to_return(:status => 200, :body => '{"expand":"projects","projects":[{"self":"http://localhost:2990/jira/rest/api/2/project/MFTP","id":"10000","key":"MFTP","name":"My first Test Project","avatarUrls":{"16x16":"http://localhost:2990/jira/secure/projectavatar?size=small&pid=10000&avatarId=10011","48x48":"http://localhost:2990/jira/secure/projectavatar?pid=10000&avatarId=10011"},"issuetypes":[{"self":"http://localhost:2990/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"http://localhost:2990/jira/images/icons/bug.gif","name":"Bug","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"http://localhost:2990/jira/images/icons/task.gif","name":"Task","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/6","id":"6","description":"An own issue type","iconUrl":"http://localhost:2990/jira/images/icons/ico_epic.png","name":"My issue type","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/5","id":"5","description":"The sub-task of the issue","iconUrl":"http://localhost:2990/jira/images/icons/issue_subtask.gif","name":"Sub-task","subtask":true},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"http://localhost:2990/jira/images/icons/improvement.gif","name":"Improvement","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"http://localhost:2990/jira/images/icons/newfeature.gif","name":"New Feature","subtask":false}]},{"self":"http://localhost:2990/jira/rest/api/2/project/SP","id":"10100","key":"SP","name":"Second Project","avatarUrls":{"16x16":"http://localhost:2990/jira/secure/projectavatar?size=small&pid=10100&avatarId=10011","48x48":"http://localhost:2990/jira/secure/projectavatar?pid=10100&avatarId=10011"},"issuetypes":[{"self":"http://localhost:2990/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"http://localhost:2990/jira/images/icons/bug.gif","name":"Bug","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"http://localhost:2990/jira/images/icons/newfeature.gif","name":"New Feature","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"http://localhost:2990/jira/images/icons/task.gif","name":"Task","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"http://localhost:2990/jira/images/icons/improvement.gif","name":"Improvement","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/5","id":"5","description":"The sub-task of the issue","iconUrl":"http://localhost:2990/jira/images/icons/issue_subtask.gif","name":"Sub-task","subtask":true},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/6","id":"6","description":"An own issue type","iconUrl":"http://localhost:2990/jira/images/icons/ico_epic.png","name":"My issue type","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/7","id":"7","description":"","iconUrl":"http://localhost:2990/jira/images/icons/genericissue.gif","name":"Trys","subtask":false}]}]}', :headers => {})
    
    assert_equal "projects", @con.execute("Get","issue/createmeta/","").result["expand"]
  end
  
  
  def test_body
    stub_request(:get, "http://test:1234@localhost:2990/jira/rest/api/2/issue/createmeta/").with(:headers => {'Accept'=>'*/*', 'Content-Type'=>'application/json;charset=UTF-8', 'User-Agent'=>'Ruby'}).to_return(:status => 200, :body => '{"expand":"projects","projects":[{"self":"http://localhost:2990/jira/rest/api/2/project/MFTP","id":"10000","key":"MFTP","name":"My first Test Project","avatarUrls":{"16x16":"http://localhost:2990/jira/secure/projectavatar?size=small&pid=10000&avatarId=10011","48x48":"http://localhost:2990/jira/secure/projectavatar?pid=10000&avatarId=10011"},"issuetypes":[{"self":"http://localhost:2990/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"http://localhost:2990/jira/images/icons/bug.gif","name":"Bug","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"http://localhost:2990/jira/images/icons/task.gif","name":"Task","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/6","id":"6","description":"An own issue type","iconUrl":"http://localhost:2990/jira/images/icons/ico_epic.png","name":"My issue type","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/5","id":"5","description":"The sub-task of the issue","iconUrl":"http://localhost:2990/jira/images/icons/issue_subtask.gif","name":"Sub-task","subtask":true},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"http://localhost:2990/jira/images/icons/improvement.gif","name":"Improvement","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"http://localhost:2990/jira/images/icons/newfeature.gif","name":"New Feature","subtask":false}]},{"self":"http://localhost:2990/jira/rest/api/2/project/SP","id":"10100","key":"SP","name":"Second Project","avatarUrls":{"16x16":"http://localhost:2990/jira/secure/projectavatar?size=small&pid=10100&avatarId=10011","48x48":"http://localhost:2990/jira/secure/projectavatar?pid=10100&avatarId=10011"},"issuetypes":[{"self":"http://localhost:2990/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"http://localhost:2990/jira/images/icons/bug.gif","name":"Bug","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"http://localhost:2990/jira/images/icons/newfeature.gif","name":"New Feature","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"http://localhost:2990/jira/images/icons/task.gif","name":"Task","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"http://localhost:2990/jira/images/icons/improvement.gif","name":"Improvement","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/5","id":"5","description":"The sub-task of the issue","iconUrl":"http://localhost:2990/jira/images/icons/issue_subtask.gif","name":"Sub-task","subtask":true},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/6","id":"6","description":"An own issue type","iconUrl":"http://localhost:2990/jira/images/icons/ico_epic.png","name":"My issue type","subtask":false},{"self":"http://localhost:2990/jira/rest/api/2/issuetype/7","id":"7","description":"","iconUrl":"http://localhost:2990/jira/images/icons/genericissue.gif","name":"Trys","subtask":false}]}]}', :headers => {})

    assert_match "http://localhost:2990/jira/rest/api/2/project", @con.execute("Get","issue/createmeta/","").body
  end
  
end
